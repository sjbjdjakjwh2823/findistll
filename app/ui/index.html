<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-src 'none';">
  <!-- Maximum extension protection -->
  <script>
    (function () {
      'use strict';

      // Block all extension injections before they load
      const originalDefineProperty = Object.defineProperty;
      Object.defineProperty = function (obj, prop, descriptor) {
        // Block ethereum property redefinition
        if (prop === 'ethereum' && obj === window) {
          console.warn('[Preciso] Blocked extension attempt to redefine window.ethereum');
          return obj;
        }
        return originalDefineProperty.call(this, obj, prop, descriptor);
      };

      // Freeze ethereum immediately if it exists
      if (window.ethereum) {
        try {
          Object.freeze(window.ethereum);
          console.log('[Preciso] Crypto wallet frozen');
        } catch (e) {
          console.warn('[Preciso] Could not freeze ethereum:', e.message);
        }
      }

      // Prevent future ethereum injection
      try {
        originalDefineProperty.call(Object, window, 'ethereum', {
          configurable: false,
          writable: false,
          value: window.ethereum || null
        });
      } catch (e) {
        console.warn('[Preciso] Ethereum property protection:', e.message);
      }

      // Global error suppression for extensions
      window.addEventListener('error', function (e) {
        if (e.filename && (
          e.filename.includes('evmAsk') ||
          e.filename.includes('extension') ||
          e.filename.includes('chrome-extension') ||
          e.filename.includes('moz-extension')
        )) {
          e.stopImmediatePropagation();
          e.preventDefault();
          console.warn('[Preciso] Extension error blocked:', e.message);
          return true;
        }
      }, true);

      // Suppress unhandled promise rejections from extensions
      window.addEventListener('unhandledrejection', function (e) {
        if (e.reason && e.reason.message && e.reason.message.includes('ethereum')) {
          e.preventDefault();
          console.warn('[Preciso] Extension promise rejection blocked');
          return true;
        }
      });

    })();
  </script>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>preciso-data</title>
  <style>
    :root {
      --bg: #0b0f14;
      --bg-2: #111826;
      --panel: #121a24;
      --panel-2: #0f1520;
      --line: #1f2a3a;
      --text: #e7edf5;
      --muted: #9fb0c5;
      --accent: #f2c94c;
      --accent-2: #6ee7b7;
      --danger: #ff6b6b;
      --glow: rgba(242, 201, 76, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--text);
      font-family: "Space Grotesk", "IBM Plex Sans", "Segoe UI", sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, #1a2433 0%, transparent 55%),
        radial-gradient(900px 500px at 10% 10%, #162230 0%, transparent 55%),
        var(--bg);
    }

    .grid {
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      opacity: 0.25;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 28px;
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(6px);
    }

    header h1 {
      font-size: 20px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    header .status {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(110, 231, 183, 0.12);
      color: var(--accent-2);
      font-weight: 600;
      font-size: 12px;
    }

    .shell {
      display: grid;
      grid-template-columns: 240px 1fr 320px;
      gap: 20px;
      padding: 20px;
    }

    nav {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      height: calc(100vh - 120px);
    }

    nav h3 {
      margin: 0 0 14px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    nav a {
      display: block;
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      text-decoration: none;
      margin-bottom: 6px;
      background: transparent;
      border: 1px solid transparent;
    }

    nav a.active {
      background: rgba(242, 201, 76, 0.08);
      border-color: rgba(242, 201, 76, 0.4);
    }

    main {
      display: grid;
      gap: 20px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
    }

    .panel h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .panel p {
      margin: 8px 0 0;
      color: var(--muted);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .field label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .field input,
    .field textarea,
    .field select {
      background: #0c121b;
      border: 1px solid var(--line);
      border-radius: 12px;
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: var(--accent);
      color: #1a1a1a;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 24px var(--glow);
    }

    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line);
      box-shadow: none;
    }

    .chips {
      display: grid;
      gap: 10px;
    }

    .chip {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #0b121c;
      font-size: 13px;
    }

    .chip strong {
      color: var(--accent);
    }

    .right-panel .panel {
      height: calc((100vh - 140px) / 2);
      overflow: auto;
    }

    pre {
      background: #0b121c;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--line);
      color: #cbe3ff;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .status-line {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-2);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .table th,
    .table td {
      border-bottom: 1px solid var(--line);
      padding: 8px;
      text-align: left;
    }

    .table th {
      color: var(--muted);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.12em;
    }

    @media (max-width: 1100px) {
      .shell {
        grid-template-columns: 1fr;
      }

      nav {
        height: auto;
      }

      .right-panel .panel {
        height: auto;
      }

      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="grid"></div>
  <header>
    <h1>PRECISO / DECISION CONSOLE</h1>
    <div class="status" id="status">SYSTEM READY</div>
  </header>

  <div class="shell">
    <nav>
      <h3>Operations</h3>
      <a class="active" href="/ui/">Cases</a>
      <a href="/ui/cases.html">Evidence</a>
      <a href="/ui/decisions.html">Decisions</a>
      <a href="/ui/audit.html">Audit</a>
      <a href="/ui/admin.html">Admin</a>
      <a href="/ui/sdkui.html">SDK UI</a>
      <h3 style="margin-top:18px;">Spokes</h3>
      <div class="chips">
        <div class="chip"><strong>A</strong> AI Tuning · 사고의 궤적(CoT) 학습</div>
        <div class="chip"><strong>B</strong> Quant · Z-Ordered Parquet 가속</div>
        <div class="chip"><strong>C</strong> RAG · PDF 좌표 기반 증거</div>
        <div class="chip"><strong>D</strong> Graph · 리스크 전파 경로 시각화</div>
      </div>
    </nav>

    <main>
      <div class="panel">
        <h2>Case Intake</h2>
        <div class="row">
          <div>
            <div class="field">
              <label>Case Title</label>
              <input id="caseTitle" placeholder="예: Samsung 2025 Q1 리스크 리뷰" />
            </div>
            <div class="actions">
              <button onclick="createCase()">Create Case</button>
              <button class="secondary" onclick="loadSample()">Load Sample</button>
            </div>
            <div class="status-line">
              <div class="dot"></div><span id="caseStatus">대기 중</span>
            </div>
          </div>
          <div>
            <div class="field">
              <label>Current Case ID</label>
              <input id="caseId" placeholder="case_1" readonly />
            </div>
            <div class="field">
              <label>Filename</label>
              <input id="filename" value="sample.txt" />
            </div>
            <div class="field">
              <label>Mime Type</label>
              <select id="mimeType">
                <option value="text/plain">text/plain</option>
                <option value="application/pdf">application/pdf</option>
                <option value="text/html">text/html</option>
                <option value="application/xml">application/xml</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Evidence Upload</h2>
        <div class="field">
          <label>Document Content (text)</label>
          <textarea id="content" rows="6" placeholder="텍스트를 넣으면 FinDistill이 facts/CoT를 생성합니다."></textarea>
        </div>
        <div class="actions">
          <button onclick="uploadDoc()">Upload Document</button>
          <button class="secondary" onclick="runPipeline()">Run Full Pipeline</button>
        </div>
        <p id="docStatus">문서 업로드 전</p>
      </div>

      <div class="panel">
        <h2>Live Outputs</h2>
        <div class="row">
          <div>
            <h3>Distill (Facts + CoT)</h3>
            <pre id="distillOut">대기 중...</pre>
          </div>
          <div>
            <h3>Decision (FinRobot)</h3>
            <pre id="decisionOut">대기 중...</pre>
          </div>
        </div>
      </div>
    </main>

    <div class="right-panel">
      <div class="panel">
        <h2>Pipeline Status</h2>
        <p>FinDistill → FinRobot Brain → Decision Workflow</p>
        <pre id="pipelineOut">No run yet.</pre>
      </div>
      <div class="panel">
        <h2>System Notes</h2>
        <p>Domain: preciso-data.com</p>
        <p>Oracle Cloud target deployment</p>
        <p>RBAC + Audit log 준비</p>
      </div>
    </div>
  </div>

  <script>
    let currentCaseId = "";
    let lastDocId = "";

    function setStatus(id, text) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = text;
      }
    }

    async function createCase() {
      const titleEl = document.getElementById("caseTitle");
      const title = titleEl ? titleEl.value : "Untitled";
      const res = await fetch("/cases", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title })
      });
      const data = await res.json();
      currentCaseId = data.case_id;
      const caseIdEl = document.getElementById("caseId");
      if (caseIdEl) {
        caseIdEl.value = currentCaseId;
      }
      setStatus("caseStatus", `Case 생성됨: ${currentCaseId}`);
    }

    async function uploadDoc() {
      if (!currentCaseId) {
        alert("먼저 Case를 생성하세요.");
        return;
      }
      const content = document.getElementById("content").value || "Sample content";
      const filename = document.getElementById("filename").value || "sample.txt";
      const mimeType = document.getElementById("mimeType").value || "text/plain";

      const res = await fetch(`/cases/${currentCaseId}/documents`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          source: "ui",
          filename,
          mime_type: mimeType,
          content
        })
      });
      const data = await res.json();
      lastDocId = data.doc_id;
      setStatus("docStatus", `문서 업로드 완료: ${lastDocId}`);
    }

    async function runPipeline() {
      if (!currentCaseId) {
        alert("먼저 Case를 생성하세요.");
        return;
      }
      const res = await fetch(`/cases/${currentCaseId}/run`, { method: "POST" });
      const data = await res.json();
      const distillEl = document.getElementById("distillOut");
      const decisionEl = document.getElementById("decisionOut");
      const pipelineEl = document.getElementById("pipelineOut");
      if (distillEl) {
        distillEl.textContent = JSON.stringify(data.distill, null, 2);
      }
      if (decisionEl) {
        decisionEl.textContent = JSON.stringify(data.decision, null, 2);
      }
      if (pipelineEl) {
        pipelineEl.textContent = JSON.stringify(data, null, 2);
      }
    }

    function loadSample() {
      const titleEl = document.getElementById("caseTitle");
      if (titleEl) {
        titleEl.value = "Tesla Q3 2025 Risk Review";
      }
      const contentEl = document.getElementById("content");
      if (contentEl) {
        contentEl.value = "Tesla reported revenue of 25.1B with gross margin 18.2%. Net income declined due to FX headwinds.";
      }
    }

    async function loadCases() {
      const tableBody = document.getElementById("casesTable");
      if (!tableBody) return;
      const res = await fetch("/cases");
      const data = await res.json();
      tableBody.innerHTML = "";
      data.forEach((c) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${c.case_id}</td><td>${c.title}</td><td>${c.status}</td>`;
        tableBody.appendChild(row);
      });
    }

    async function loadDocuments() {
      const tableBody = document.getElementById("docsTable");
      if (!tableBody) return;
      const res = await fetch("/documents");
      const data = await res.json();
      tableBody.innerHTML = "";
      data.forEach((d) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${d.doc_id}</td><td>${d.filename || ""}</td><td>${d.mime_type || ""}</td>`;
        tableBody.appendChild(row);
      });
    }

    async function loadDecisions() {
      const tableBody = document.getElementById("decisionsTable");
      if (!tableBody) return;
      const res = await fetch("/cases");
      const data = await res.json();
      tableBody.innerHTML = "";
      data.forEach((c) => {
        const decision = c.decision ? c.decision.decision : "-";
        const rationale = c.decision ? c.decision.rationale : "-";
        const row = document.createElement("tr");
        row.innerHTML = `<td>${c.case_id}</td><td>${decision}</td><td>${rationale}</td>`;
        tableBody.appendChild(row);
      });
    }

    window.addEventListener("load", () => {
      loadCases();
      loadDocuments();
      loadDecisions();
    });

  </script>
</body>

</html>
